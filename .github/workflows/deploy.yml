name: deploy

on:
  push:
    branches: [dev, staging, main]

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

env:
  RG: admiro-rg
  ACR_NAME: acradmiro

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Map branch -> apps
        shell: bash
        run: |
          BR="${GITHUB_REF_NAME}"
          echo "BR=$BR" >> $GITHUB_ENV
          echo "TAG=${BR}-${GITHUB_SHA}" >> $GITHUB_ENV

          if [ "$BR" = "dev" ]; then
            echo "BACK_APP=admiro-backend-dev" >> $GITHUB_ENV
            echo "FRONT_APP=admiro-frontend-dev" >> $GITHUB_ENV
          elif [ "$BR" = "staging" ]; then
            echo "BACK_APP=admiro-backend-staging" >> $GITHUB_ENV
            echo "FRONT_APP=admiro-frontend-staging" >> $GITHUB_ENV
          else
            # main -> prod
            echo "BACK_APP=admiro-backend-prod" >> $GITHUB_ENV
            echo "FRONT_APP=admiro-frontend-prod" >> $GITHUB_ENV
          fi

      - name: Resolve ACR server
        shell: bash
        run: |
          ACR_SERVER=$(az acr show -g "$RG" -n "$ACR_NAME" --query loginServer -o tsv)
          echo "ACR_SERVER=$ACR_SERVER" >> $GITHUB_ENV

      # ---------- BACKEND ----------
      - name: Build + push backend (ACR build)
        shell: bash
        run: |
          az acr build -g "$RG" -r "$ACR_NAME" \
            -t "admiro-backend:${TAG}" \
            -f backend/Dockerfile \
            ./backend

      - name: Deploy backend
        shell: bash
        run: |
          az containerapp update -g "$RG" -n "$BACK_APP" \
            --image "$ACR_SERVER/admiro-backend:${TAG}"

      - name: Get backend URL
        shell: bash
        run: |
          FQDN=$(az containerapp show -g "$RG" -n "$BACK_APP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "BACKEND_URL=https://${FQDN}" >> $GITHUB_ENV
          echo "Backend: https://${FQDN}"

      # ---------- FRONTEND ----------
      - name: Build + push frontend (ACR build)
        shell: bash
        run: |
          az acr build -g "$RG" -r "$ACR_NAME" \
            -t "admiro-frontend:${TAG}" \
            -f frontend/Dockerfile.prod \
            --build-arg VITE_API_BASE_URL="$BACKEND_URL" \
            ./frontend

      - name: Deploy frontend
        shell: bash
        run: |
          az containerapp update -g "$RG" -n "$FRONT_APP" \
            --image "$ACR_SERVER/admiro-frontend:${TAG}"

      - name: Print frontend URL
        shell: bash
        run: |
          FQDN=$(az containerapp show -g "$RG" -n "$FRONT_APP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "Frontend: https://${FQDN}"
